<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Symptom Checker</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    .section { display: none; }
    .section.active { display: block; }
    .nav-buttons { margin-top: 30px; text-align: center; }
    .nav-buttons button { margin: 0 10px; padding: 10px 20px; }
    #suggestions div {
      padding: 5px 10px;
      background: #f0f0f0;
      margin-top: 2px;
    }
    #selected-symptoms span {
      display: inline-block;
      background: #d4edda;
      margin: 5px;
      padding: 5px 10px;
      border-radius: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h2>Symptom Checker</h2>

  <!-- Step 1: Basic Info -->
  <div id="step-1" class="section active">
    {% if not user_logged_in %}
      <form id="basic-info-form">
        <label>Age: <input type="number" name="age" required></label><br><br>
        <label>Gender:
          <select name="gender" id="gender-select" required onchange="loadBodyImage()">
            <option value="">--Select--</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </label><br><br>
      </form>
    {% else %}
      <input type="hidden" id="gender-select" value="{{ user_gender }}">
      <input type="hidden" id="user-age" value="{{ user_age }}">
    {% endif %}
  </div>

  <!-- Step 2: Symptom Input -->
  <div id="step-2" class="section">
    <h3>Select Symptoms</h3>
    <input type="text" id="symptom-search" placeholder="Type symptoms..." autocomplete="off"/>
    
    <div id="body-map">
      <h4>Select Body View</h4>
      <div style="margin-bottom: 10px;">
        <label>Gender:</label>
        <select id="gender-select" onchange="loadBodyImage()">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
        <label style="margin-left: 20px;">View:</label>
        <select id="view-select" onchange="loadBodyImage()">
          <option value="front">Front</option>
          <option value="back">Back</option>
        </select>
      </div> 

      <div id="body-container">
        <img id="body-image" src="" usemap="#body-map" alt="Body Map" style="max-width: 300px;">
        <map name="body-map" id="body-map">
          <area shape="rect" coords="120,20,180,70" alt="Head" onclick="selectRegion('head')">
          <area shape="rect" coords="125,70,175,100" alt="Face" onclick="selectRegion('face')">
          <area shape="rect" coords="125,100,175,120" alt="Neck" onclick="selectRegion('neck')">
          <area shape="rect" coords="110,120,190,160" alt="Chest" onclick="selectRegion('chest')">
          <area shape="rect" coords="120,160,180,180" alt="Breast" onclick="selectRegion('breast')">
          <area shape="rect" coords="110,180,190,220" alt="Upper Abdomen" onclick="selectRegion('upper_abdomen')">
          <area shape="rect" coords="110,220,190,260" alt="Lower Abdomen" onclick="selectRegion('lower_abdomen')">
          <area shape="rect" coords="110,260,190,300" alt="Pelvis" onclick="selectRegion('pelvic')">
          <area shape="rect" coords="50,70,100,200" alt="Left Arm" onclick="selectRegion('arm')">
          <area shape="rect" coords="200,70,250,200" alt="Right Arm" onclick="selectRegion('arm')">
          <area shape="rect" coords="60,300,120,500" alt="Left Leg" onclick="selectRegion('leg')">
          <area shape="rect" coords="180,300,240,500" alt="Right Leg" onclick="selectRegion('leg')">
          <area shape="rect" coords="110,300,190,360" alt="Buttock" onclick="selectRegion('buttock')">
          <area shape="rect" coords="120,360,180,400" alt="Foot" onclick="selectRegion('foot')">
          <area shape="rect" coords="0,0,300,600" alt="Skin" onclick="selectRegion('skin')">
        </map>
      </div>

      <div id="zoom-container" style="position: relative; width: 300px; display: none;">
        <img id="body-image" src="/static/images/female-front.png" style="width: 100%;" />
            
        <svg id="body-overlay" viewBox="0 0 300 600"
             style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
            
          <!-- Head -->
          <polygon points="120,20 180,20 180,70 120,70"
                   fill="transparent"
                   stroke="blue"
                   stroke-width="2"
                   onmouseover="this.style.fill='#cceeff'"
                   onmouseout="this.style.fill='transparent'"
                   onclick="selectRegion('head')" />
            
          <!-- Chest -->
          <polygon points="100,80 200,80 200,140 100,140"
                   fill="transparent"
                   stroke="green"
                   stroke-width="2"
                   onmouseover="this.style.fill='#ccffcc'"
                   onmouseout="this.style.fill='transparent'"
                   onclick="selectRegion('chest')" />
            
          <!-- Abdomen -->
          <polygon points="100,150 200,150 200,210 100,210"
                   fill="transparent"
                   stroke="orange"
                   stroke-width="2"
                   onmouseover="this.style.fill='#ffedcc'"
                   onmouseout="this.style.fill='transparent'"
                   onclick="selectRegion('upper_abdomen')" />
        </svg>
      </div>

    </div>
    <div id="suggestions"></div>
    <div id="selected-symptoms"></div>
    <button onclick="submitSymptoms()">Check for Possible Diseases</button>
  </div>

  <!-- Step 3: Prediction Results -->
  <div id="step-3" class="section">
    <h3>Possible Disease:</h3>
    <p id="disease-result" style="font-size: 1.5em; font-weight: bold;"></p>
    <button onclick="nextStep()">View Details</button>
  </div>

  <!-- Step 4: Disease Details -->
  <div id="step-4" class="section">
    <h3>Disease Details</h3>
    <div id="disease-details">Coming soon...</div>
  </div>

  <!-- Step 5: Treatment Info -->
  <div id="step-5" class="section">
    <h3>Treatment</h3>
    <div id="treatment-info">Coming soon...</div>
  </div>

  <!-- Navigation Buttons -->
  <div class="nav-buttons">
    <button onclick="prevStep()">Previous</button>
    <button onclick="nextStep()">Next</button>
  </div>

  <script>
    let currentStep = 1;
    const totalSteps = 5;
    let symptomsList = [];
    let selectedSymptoms = [];

    function showStep(step) {
      for (let i = 1; i <= totalSteps; i++) {
        document.getElementById('step-' + i).classList.remove('active');
      }
      document.getElementById('step-' + step).classList.add('active');
    }

    function nextStep() {
      if (currentStep < totalSteps) {
        currentStep++;
        showStep(currentStep);
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
      }
    }

    // Load symptoms.json
    fetch('/static/data/symptoms.json')
      .then(res => res.json())
      .then(data => {
        symptomsList = data.map(s => s.toLowerCase());
      });

    document.getElementById('symptom-search').addEventListener('input', function() {
      const query = this.value.toLowerCase();
      const matches = symptomsList.filter(s => s.includes(query) && !selectedSymptoms.includes(s));
      const suggestions = document.getElementById('suggestions');
      suggestions.innerHTML = '';

      matches.slice(0, 8).forEach(symptom => {
        const div = document.createElement('div');
        div.textContent = symptom;
        div.className = 'suggestion';
        div.onclick = () => selectSymptom(symptom);
        suggestions.appendChild(div);
      });
    });

    function selectSymptom(symptom) {
      selectedSymptoms.push(symptom);
      updateSelectedList();
      document.getElementById('symptom-search').value = '';
      document.getElementById('suggestions').innerHTML = '';
    }

    function updateSelectedList() {
      const container = document.getElementById('selected-symptoms');
      container.innerHTML = '';
      selectedSymptoms.forEach((s, i) => {
        const chip = document.createElement('span');
        chip.textContent = s + ' Ã—';
        chip.onclick = () => {
          selectedSymptoms.splice(i, 1);
          updateSelectedList();
        };
        container.appendChild(chip);
      });
    }

    function submitSymptoms() {
      if (selectedSymptoms.length === 0) {
        alert("Please select at least one symptom.");
        return;
      }

      const payload = {};
      selectedSymptoms.forEach(sym => {
        payload[sym.toLowerCase()] = 1;
      });

      fetch('/predict', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.predicted_disease) {
          document.getElementById('disease-result').textContent = data.predicted_disease;
          nextStep();
        } else {
          alert("No prediction received.");
        }
      })
      .catch(err => {
        console.error("Prediction error:", err);
        alert("Prediction failed.");
      });
    }

    function loadDiseaseInfo(name) {
      fetch('/static/data/diseases.json')
        .then(res => res.json())
        .then(data => {
          const match = data.find(d => d.name.toLowerCase() === name.toLowerCase());
          if (match) {
            document.getElementById('disease-details').textContent = match.details;
            document.getElementById('treatment-info').textContent = match.treatment;
          } else {
            document.getElementById('disease-details').textContent = "No details found.";
            document.getElementById('treatment-info').textContent = "No treatment info available.";
          }
        })
        .catch(err => {
          console.error("Failed to load disease info:", err);
        });
    }

    // Call this when you move from Step 3 to Step 4
    function nextStep() {
      if (currentStep === 3) {
        const disease = document.getElementById('disease-result').textContent;
        loadDiseaseInfo(disease);
      }
      if (currentStep < totalSteps) {
        currentStep++;
        showStep(currentStep);
      }
    }

    const symptomByBodyPart = {
      head: ["headache", "dizziness", "vision problems"],
      chest: ["chest pain", "shortness of breath", "palpitations"],
      abdomen: ["abdominal pain", "nausea", "vomiting", "diarrhea"],
      leg: ["swelling", "muscle pain", "joint pain"],
      // Expand as needed
    };

    const detailedSymptomMap = {
      head: ["scalp tenderness", "headache", "dizziness", "loss of balance"],
      face: ["facial pain", "numbness", "facial swelling"],
      eye: ["blurry vision", "eye pain", "red eye"],
      ear: ["hearing loss", "earache", "ear discharge"],
      mouth: ["sore throat", "ulcers", "bad breath"],
      neck: ["neck stiffness", "swollen glands", "pain turning neck"],
      chest: ["chest pain", "shortness of breath", "palpitations"],
      breast: ["breast lump", "pain", "nipple discharge"],
      upper_abdomen: ["nausea", "vomiting", "epigastric pain"],
      lower_abdomen: ["cramps", "diarrhea", "bloating"],
      pelvic: ["pelvic pain", "genital itching", "abnormal discharge"],
      back: ["back pain", "stiffness", "muscle spasm"],
      buttock: ["buttock pain", "numbness", "rectal bleeding"],
      leg: ["leg cramps", "swelling", "tingling"],
      foot: ["foot pain", "numbness", "cold feet"],
      arm: ["arm weakness", "joint pain", "numbness"],
      hand: ["hand tremor", "joint stiffness", "finger swelling"],
      skin: ["rash", "itching", "redness", "dry skin"]
    };

    function selectBodyPart(part) {
      const options = symptomByBodyPart[part] || [];
      options.forEach(sym => {
        if (!selectedSymptoms.includes(sym)) {
          selectedSymptoms.push(sym);
        }
      });
      updateSelectedList();
    }

    function loadBodyImage() {
      const genderEl = document.getElementById('gender-select');
      const gender = genderEl ? genderEl.value : 'male'; // fallback
    
      const view = document.getElementById('view-select').value;
      const img = document.getElementById('body-image');
      img.src = `/static/images/${gender}-${view}.png`;
    }

    window.onload = function() {
      const genderEl = document.getElementById('gender-select');
      if (genderEl && genderEl.tagName === "INPUT") {
        // Hide gender and load image immediately
        document.getElementById('gender-select').style.display = 'none';
        loadBodyImage();
      } else {
        // Wait for selection by user
        document.getElementById('gender-select').addEventListener('change', loadBodyImage);
      }
    };

    function selectRegion(region) {
      const symptoms = detailedSymptomMap[region] || [];
      if (symptoms.length === 0) {
        alert("No symptoms defined for this region.");
        return;
      }
    
      let list = `Select symptoms for ${region}:\n`;
      symptoms.forEach((s, i) => {
        list += `${i + 1}. ${s}\n`;
      });
    
      const input = prompt(list + "\nEnter numbers separated by commas (e.g., 1,3)");
      if (input) {
        const choices = input.split(',').map(i => parseInt(i.trim()) - 1);
        choices.forEach(i => {
          if (symptoms[i] && !selectedSymptoms.includes(symptoms[i])) {
            selectedSymptoms.push(symptoms[i]);
          }
        });
        updateSelectedList();
      }
    }

  </script>  
</body>
</html>
